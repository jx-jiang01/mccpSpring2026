<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editable Diagram — UpANNS</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&family=Times+New+Roman&display=swap" rel="stylesheet">
<style>
  :root { --panel-w: 280px; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Source Sans Pro', system-ui, sans-serif; background: #f0f2f5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

  /* ── Toolbar ── */
  #toolbar {
    display: flex; align-items: center; gap: 10px;
    padding: 8px 16px; background: #1e293b; color: #fff;
    box-shadow: 0 2px 6px rgba(0,0,0,.25); z-index: 10;
  }
  #toolbar h1 { font-size: 15px; font-weight: 600; margin-right: auto; }
  .tb-btn {
    padding: 6px 14px; border: none; border-radius: 5px;
    font-size: 13px; font-weight: 600; cursor: pointer;
    transition: background .15s;
  }
  .tb-btn.primary { background: #3b82f6; color: #fff; }
  .tb-btn.primary:hover { background: #2563eb; }
  .tb-btn.secondary { background: #475569; color: #e2e8f0; }
  .tb-btn.secondary:hover { background: #64748b; }
  .tb-btn.danger { background: #ef4444; color: #fff; }
  .tb-btn.danger:hover { background: #dc2626; }
  .tb-sep { width: 1px; height: 24px; background: #475569; }

  /* ── Layout ── */
  #main { display: flex; flex: 1; overflow: hidden; }
  #canvas-wrap {
    flex: 1; overflow: auto; padding: 20px;
    display: flex; justify-content: center; align-items: flex-start;
  }
  #canvas {
    background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,.12);
    border-radius: 8px; padding: 10px; max-width: 1340px; width: 100%;
  }
  #canvas svg { cursor: default; }
  svg text { font-family: 'Source Sans Pro', 'Times New Roman', serif; }

  /* ── Selection highlight ── */
  .el-selected { outline: 2px solid #3b82f6; outline-offset: 1px; }

  /* ── Properties panel ── */
  #panel {
    width: var(--panel-w); min-width: var(--panel-w);
    background: #1e293b; color: #e2e8f0; padding: 16px;
    overflow-y: auto; font-size: 13px;
    border-left: 1px solid #334155;
  }
  #panel h2 { font-size: 14px; margin-bottom: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: .5px; }
  #panel .empty-msg { color: #64748b; font-style: italic; margin-top: 20px; }
  .prop-row { margin-bottom: 10px; }
  .prop-row label { display: block; font-size: 11px; color: #94a3b8; margin-bottom: 3px; text-transform: uppercase; }
  .prop-row input[type="text"], .prop-row textarea {
    width: 100%; padding: 5px 8px; border: 1px solid #475569;
    border-radius: 4px; background: #0f172a; color: #e2e8f0; font-size: 13px;
  }
  .prop-row textarea { min-height: 50px; resize: vertical; font-family: inherit; }
  .prop-row input[type="color"] {
    width: 36px; height: 28px; border: 1px solid #475569; border-radius: 4px;
    cursor: pointer; background: none; padding: 1px;
  }
  .prop-row .color-group { display: flex; align-items: center; gap: 8px; }
  .prop-row .color-hex { font-family: monospace; font-size: 12px; color: #94a3b8; }
  .prop-row .inline { display: flex; gap: 6px; }
  .prop-row .inline input { flex: 1; }
  .prop-apply {
    padding: 5px 12px; border: none; border-radius: 4px;
    background: #3b82f6; color: #fff; cursor: pointer;
    font-size: 12px; font-weight: 600; margin-top: 4px;
  }
  .prop-apply:hover { background: #2563eb; }

  /* ── Inline text editor overlay ── */
  #text-editor {
    position: fixed; z-index: 100; display: none;
    background: #fff; border: 2px solid #3b82f6; border-radius: 4px;
    padding: 4px 6px; font-family: 'Source Sans Pro', sans-serif;
    box-shadow: 0 4px 12px rgba(0,0,0,.2); min-width: 60px;
  }
  #text-editor input {
    border: none; outline: none; font-size: 14px; width: 100%;
    min-width: 50px; background: transparent;
  }

  /* ── Toast notification ── */
  #toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
    background: #1e293b; color: #e2e8f0; padding: 10px 20px;
    border-radius: 6px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,.3);
    opacity: 0; transition: opacity .3s; pointer-events: none; z-index: 200;
  }
  #toast.show { opacity: 1; }
</style>
</head>
<body>

<!-- ═══════════ Toolbar ═══════════ -->
<div id="toolbar">
  <h1>Diagram Editor</h1>
  <button class="tb-btn secondary" onclick="resetAll()" title="Undo all changes">Reset</button>
  <div class="tb-sep"></div>
  <button class="tb-btn primary" onclick="downloadHTML()">Download HTML</button>
  <button class="tb-btn primary" onclick="downloadSVG()">Download SVG</button>
</div>

<!-- ═══════════ Main area ═══════════ -->
<div id="main">

<!-- Canvas -->
<div id="canvas-wrap">
<div id="canvas">
<svg id="diagram" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1300 560" width="100%">
  <defs>
    <marker id="arrowBlack" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
      <path d="M0,0 L8,3 L0,6 Z" fill="#444"/>
    </marker>
    <marker id="arrowBlackSmall" markerWidth="6" markerHeight="5" refX="6" refY="2.5" orient="auto">
      <path d="M0,0 L6,2.5 L0,5 Z" fill="#444"/>
    </marker>
    <linearGradient id="blueBoxBg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#d6e8f7"/>
      <stop offset="100%" stop-color="#c4ddf0"/>
    </linearGradient>
    <linearGradient id="blueBoxBg2" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#d0e4f4"/>
      <stop offset="100%" stop-color="#bdd8ee"/>
    </linearGradient>
    <symbol id="dpuChip" viewBox="0 0 36 36">
      <rect x="8" y="8" width="20" height="20" rx="2" fill="#2a6496" stroke="#1a4a72" stroke-width="1"/>
      <rect x="12" y="12" width="12" height="12" rx="1" fill="#3a7ab8"/>
      <line x1="12" y1="8" x2="12" y2="3" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="18" y1="8" x2="18" y2="3" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="24" y1="8" x2="24" y2="3" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="12" y1="28" x2="12" y2="33" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="18" y1="28" x2="18" y2="33" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="24" y1="28" x2="24" y2="33" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="8" y1="12" x2="3" y2="12" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="8" y1="18" x2="3" y2="18" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="8" y1="24" x2="3" y2="24" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="28" y1="12" x2="33" y2="12" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="28" y1="18" x2="33" y2="18" stroke="#1a4a72" stroke-width="1.5"/>
      <line x1="28" y1="24" x2="33" y2="24" stroke="#1a4a72" stroke-width="1.5"/>
    </symbol>
  </defs>

  <!-- ==================== OFFLINE SECTION ==================== -->
  <text x="72" y="25" font-size="14" font-weight="700" text-anchor="middle" fill="#1a1a1a">Encoded points</text>

  <text x="18" y="50" font-size="11.5" font-style="italic" fill="#333">Vector 0</text>
  <g transform="translate(75, 36)">
    <rect x="0" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="13" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="26" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="39" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="52" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="65" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="78" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="91" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
  </g>

  <text x="18" y="67" font-size="11.5" font-style="italic" fill="#333">Vector 1</text>
  <g transform="translate(75, 53)">
    <rect x="0" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="13" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="26" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="39" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="52" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="65" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="78" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="91" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
  </g>

  <text x="18" y="84" font-size="11.5" font-style="italic" fill="#333">Vector 2</text>
  <g transform="translate(75, 70)">
    <rect x="0" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="13" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="26" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="39" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="52" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="65" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="78" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="91" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
  </g>

  <text x="100" y="103" font-size="18" font-weight="700" fill="#333" text-anchor="middle">&#x22EE;</text>

  <text x="18" y="127" font-size="11.5" font-style="italic" fill="#333">Vector n</text>
  <g transform="translate(75, 113)">
    <rect x="0" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="13" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="26" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="39" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="52" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="65" y="0" width="12" height="12" fill="#bbb" stroke="#aaa" stroke-width="0.5"/>
    <rect x="78" y="0" width="12" height="12" fill="#e8c98a" stroke="#aaa" stroke-width="0.5"/>
    <rect x="91" y="0" width="12" height="12" fill="#8fc48a" stroke="#aaa" stroke-width="0.5"/>
  </g>

  <polygon points="182,72 222,72 222,66 236,80 222,94 222,88 182,88" fill="#bbb" stroke="#999" stroke-width="0.5"/>

  <!-- Co-occurrence Aware Encoding -->
  <rect x="245" y="8" width="380" height="210" rx="6" fill="url(#blueBoxBg)" stroke="#7badd4" stroke-width="1.5"/>
  <text x="435" y="228" font-size="13" font-weight="600" text-anchor="middle" fill="#1a1a1a">Co-occurrence Aware Encoding</text>
  <rect x="320" y="16" width="160" height="32" rx="4" fill="#4a90b8" opacity="0.85"/>
  <text x="400" y="30" font-size="11" font-weight="600" text-anchor="middle" fill="white">High Frequent</text>
  <text x="400" y="43" font-size="11" font-weight="600" text-anchor="middle" fill="white">Co-occurrence</text>

  <g transform="translate(270, 55)">
    <rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="0" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/>
    <rect x="0" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="15" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="15" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="60" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="15" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="15" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="15" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/>
    <rect x="0" y="30" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="30" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="30" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="30" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="30" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/>
    <rect x="0" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="45" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="45" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="45" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="45" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/>
    <rect x="0" y="60" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="15" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="60" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="60" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="90" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="60" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/>
    <rect x="0" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="15" y="75" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="30" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="45" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="60" y="75" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="75" y="75" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="90" y="75" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="105" y="75" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/>
  </g>

  <text x="420" y="130" font-size="13" font-weight="600" fill="#1a1a1a">Encode</text>
  <line x1="395" y1="100" x2="460" y2="65" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="395" y1="120" x2="460" y2="100" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="395" y1="140" x2="460" y2="135" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="395" y1="160" x2="460" y2="165" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="395" y1="175" x2="460" y2="195" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>

  <g transform="translate(465, 50)"><rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="32" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/><rect x="48" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465, 85)"><rect x="0" y="0" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#2d6b2d" stroke="#bbb" stroke-width="0.5"/><rect x="32" y="0" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="48" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465, 120)"><rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#e8a050" stroke="#bbb" stroke-width="0.5"/><rect x="32" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465, 155)"><rect x="0" y="0" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="16" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/></g>
  <g transform="translate(465, 185)"><rect x="0" y="0" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/></g>

  <line x1="535" y1="65" x2="570" y2="100" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="535" y1="95" x2="570" y2="105" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="530" y1="130" x2="570" y2="115" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="520" y1="165" x2="570" y2="130" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="510" y1="195" x2="570" y2="140" stroke="#888" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>

  <g transform="translate(575, 80)">
    <rect x="0" y="0" width="14" height="14" fill="#ddd" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="15" width="14" height="14" fill="#8fc48a" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="30" width="14" height="14" fill="#2d6b2d" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="45" width="14" height="14" fill="#e8a050" stroke="#bbb" stroke-width="0.5"/><rect x="0" y="60" width="14" height="14" fill="#bbb" stroke="#999" stroke-width="0.5"/><rect x="0" y="75" width="14" height="14" fill="#e8c98a" stroke="#bbb" stroke-width="0.5"/>
  </g>

  <polygon points="630,104 670,104 670,98 684,112 670,126 670,120 630,120" fill="#bbb" stroke="#999" stroke-width="0.5"/>

  <!-- Copy & Distribute -->
  <rect x="695" y="8" width="580" height="210" rx="6" fill="url(#blueBoxBg)" stroke="#7badd4" stroke-width="1.5"/>
  <text x="985" y="28" font-size="14" font-weight="700" text-anchor="middle" fill="#1a5a8a">Copy &amp; Distribute</text>

  <g transform="translate(720, 42)">
    <g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#4a8a4a" stroke-width="0.7"/></g>
    <g transform="translate(0, 30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/></g>
  </g>
  <g transform="translate(775, 42)">
    <g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8a050" stroke="#c07830" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8a050"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d89040" stroke="#c07830" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#c07830" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#c07830" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#c07830" stroke-width="0.7"/></g>
    <g transform="translate(0, 30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8a050" stroke="#c07830" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8a050"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d89040" stroke="#c07830" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#c07830" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#c07830" stroke-width="0.7"/></g>
  </g>
  <g transform="translate(830, 42)">
    <g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8d86a" stroke="#b8a840" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8d86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d8c860" stroke="#b8a840" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#b8a840" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#b8a840" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#b8a840" stroke-width="0.7"/></g>
    <g transform="translate(0, 30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#e8d86a" stroke="#b8a840" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#e8d86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#d8c860" stroke="#b8a840" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#b8a840" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#b8a840" stroke-width="0.7"/></g>
  </g>
  <text x="890" y="80" font-size="22" font-weight="700" fill="#333">&#x00B7;&#x00B7;&#x00B7;</text>
  <g transform="translate(920, 42)">
    <g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#4a8a4a" stroke-width="0.7"/></g>
    <g transform="translate(0, 30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#6ab86a" stroke="#4a8a4a" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#6ab86a"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#5aa85a" stroke="#4a8a4a" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#4a8a4a" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#4a8a4a" stroke-width="0.7"/></g>
  </g>
  <g transform="translate(975, 42)">
    <g><ellipse cx="18" cy="8" rx="14" ry="6" fill="#a8d868" stroke="#7aaa48" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#a8d868"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#98c858" stroke="#7aaa48" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#7aaa48" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#7aaa48" stroke-width="0.7"/><ellipse cx="18" cy="8" rx="14" ry="6" fill="none" stroke="#7aaa48" stroke-width="0.7"/></g>
    <g transform="translate(0, 30)"><ellipse cx="18" cy="8" rx="14" ry="6" fill="#a8d868" stroke="#7aaa48" stroke-width="0.7"/><rect x="4" y="8" width="28" height="20" fill="#a8d868"/><ellipse cx="18" cy="28" rx="14" ry="6" fill="#98c858" stroke="#7aaa48" stroke-width="0.7"/><line x1="4" y1="8" x2="4" y2="28" stroke="#7aaa48" stroke-width="0.7"/><line x1="32" y1="8" x2="32" y2="28" stroke="#7aaa48" stroke-width="0.7"/></g>
  </g>

  <text x="985" y="155" font-size="14" font-weight="700" text-anchor="middle" fill="#1a5a8a">Data Transfer</text>
  <line x1="738" y1="108" x2="738" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/>
  <line x1="793" y1="108" x2="793" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/>
  <line x1="848" y1="108" x2="848" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/>
  <line x1="938" y1="108" x2="938" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/>
  <line x1="993" y1="108" x2="993" y2="130" stroke="#666" stroke-width="1" marker-end="url(#arrowBlackSmall)"/>

  <use href="#dpuChip" x="720" y="132" width="36" height="36"/>
  <use href="#dpuChip" x="775" y="132" width="36" height="36"/>
  <use href="#dpuChip" x="830" y="132" width="36" height="36"/>
  <text x="885" y="155" font-size="16" font-weight="700" fill="#333">&#x00B7;&#x00B7;&#x00B7;</text>
  <use href="#dpuChip" x="920" y="132" width="36" height="36"/>
  <use href="#dpuChip" x="975" y="132" width="36" height="36"/>

  <text x="738" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 0</text>
  <text x="793" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 1</text>
  <text x="848" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 2</text>
  <text x="938" y="182" font-size="10" text-anchor="middle" fill="#333">DPU 0</text>
  <text x="993" y="182" font-size="10" text-anchor="middle" fill="#333">DPU n</text>

  <!-- Divider -->
  <line x1="0" y1="270" x2="1300" y2="270" stroke="#666" stroke-width="1.5" stroke-dasharray="8,5"/>
  <text x="15" y="262" font-size="18" font-weight="700" font-style="italic" fill="#c0392b">Offline</text>
  <text x="15" y="286" font-size="18" font-weight="700" font-style="italic" fill="#c0392b">Online</text>

  <!-- ==================== ONLINE SECTION ==================== -->
  <rect x="30" y="305" width="285" height="195" rx="6" fill="#eee" stroke="#ccc" stroke-width="1.5" opacity="0.6"/>
  <text x="50" y="322" font-size="14" font-weight="700" fill="#333">CPU</text>

  <rect x="50" y="430" width="72" height="42" rx="4" fill="white" stroke="#666" stroke-width="1"/>
  <text x="86" y="448" font-size="10.5" font-weight="600" text-anchor="middle" fill="#333">Query</text>
  <text x="86" y="461" font-size="10.5" font-weight="600" text-anchor="middle" fill="#333">Batch</text>

  <line x1="122" y1="451" x2="148" y2="451" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="152" y="425" width="100" height="50" rx="4" fill="#d6e8f7" stroke="#7badd4" stroke-width="1.2"/>
  <text x="202" y="447" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2460;Cluster</text>
  <text x="202" y="461" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">Filtering</text>

  <line x1="202" y1="425" x2="202" y2="385" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="152" y="335" width="100" height="48" rx="4" fill="#d6e8f7" stroke="#7badd4" stroke-width="1.2"/>
  <text x="202" y="355" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2461;Query</text>
  <text x="202" y="369" font-size="11" font-weight="700" text-anchor="middle" fill="#1a5a8a">Scheduling</text>

  <line x1="252" y1="359" x2="310" y2="359" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <text x="328" y="400" font-size="20" font-weight="700" fill="#333">&#x22EE;</text>
  <line x1="310" y1="359" x2="340" y2="340" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="310" y1="359" x2="340" y2="359" stroke="#444" stroke-width="1.2"/>
  <line x1="335" y1="359" x2="375" y2="359" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <text x="335" y="485" font-size="12" font-weight="600" fill="#333">DPU &#x00D7; n</text>
  <line x1="310" y1="359" x2="340" y2="420" stroke="#444" stroke-width="1.2"/>
  <line x1="340" y1="420" x2="340" y2="470" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>

  <!-- DPU Processing Box -->
  <rect x="380" y="300" width="895" height="220" rx="6" fill="url(#blueBoxBg2)" stroke="#7badd4" stroke-width="1.5"/>
  <text x="400" y="318" font-size="14" font-weight="700" fill="#1a5a8a">DPU</text>

  <rect x="410" y="330" width="135" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/>
  <text x="477" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2462;LUT</text>
  <text x="477" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Construction</text>

  <line x1="545" y1="356" x2="570" y2="356" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="575" y="330" width="145" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/>
  <text x="647" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2463;Distance</text>
  <text x="647" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Calculation</text>

  <line x1="720" y1="356" x2="750" y2="356" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="755" y="330" width="135" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/>
  <text x="822" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2464;TOP-K</text>
  <text x="822" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Pruning</text>

  <line x1="890" y1="356" x2="925" y2="356" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <rect x="930" y="330" width="145" height="52" rx="4" fill="white" stroke="#7badd4" stroke-width="1.2"/>
  <text x="1002" y="352" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">&#x2465;Identifying</text>
  <text x="1002" y="368" font-size="12" font-weight="700" text-anchor="middle" fill="#1a5a8a">Top-k</text>

  <text x="760" y="405" font-size="13" font-weight="600" font-style="italic" fill="#c0392b">Control</text>
  <line x1="647" y1="382" x2="647" y2="430" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="647" y1="432" x2="647" y2="384" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="822" y1="382" x2="822" y2="430" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>
  <line x1="822" y1="432" x2="822" y2="384" stroke="#444" stroke-width="1.2" marker-end="url(#arrowBlackSmall)"/>

  <rect x="490" y="430" width="475" height="75" rx="5" fill="#d6e8f7" stroke="#7badd4" stroke-width="1.2"/>
  <text x="727" y="497" font-size="13" font-weight="700" text-anchor="middle" fill="#1a5a8a">Efficient Resource Management</text>

  <rect x="520" y="440" width="185" height="38" rx="4" fill="white" stroke="#7badd4" stroke-width="1"/>
  <text x="612" y="464" font-size="12" font-weight="600" text-anchor="middle" fill="#1a5a8a">Thread Scheduling</text>

  <rect x="740" y="440" width="195" height="38" rx="4" fill="white" stroke="#7badd4" stroke-width="1"/>
  <text x="837" y="464" font-size="12" font-weight="600" text-anchor="middle" fill="#1a5a8a">Memory Management</text>

  <!-- Caption -->
  <text x="650" y="545" font-size="15" font-weight="400" text-anchor="middle" fill="#1a1a1a" font-family="'Times New Roman', serif">
    Figure 5: Overview of UpANNS. The grey blocks in each vector represent high frequency co-occurrences in the encoded vectors.
  </text>
</svg>
</div>
</div>

<!-- ═══════════ Properties Panel ═══════════ -->
<div id="panel">
  <h2>Properties</h2>
  <div id="panel-empty" class="empty-msg">Click an element to select it.<br><br>Double-click text to edit inline.<br><br>Click a coloured square to change its fill.</div>
  <div id="panel-props" style="display:none">
    <div class="prop-row">
      <label>Element</label>
      <input type="text" id="prop-type" readonly style="opacity:.6">
    </div>
    <div class="prop-row" id="prop-text-row">
      <label>Text content</label>
      <textarea id="prop-text"></textarea>
      <button class="prop-apply" onclick="applyText()">Apply</button>
    </div>
    <div class="prop-row" id="prop-fill-row">
      <label>Fill colour</label>
      <div class="color-group">
        <input type="color" id="prop-fill" onchange="applyFill()">
        <span class="color-hex" id="prop-fill-hex"></span>
      </div>
    </div>
    <div class="prop-row" id="prop-stroke-row">
      <label>Stroke colour</label>
      <div class="color-group">
        <input type="color" id="prop-stroke" onchange="applyStroke()">
        <span class="color-hex" id="prop-stroke-hex"></span>
      </div>
    </div>
    <div class="prop-row" id="prop-fontsize-row">
      <label>Font size (px)</label>
      <div class="inline">
        <input type="text" id="prop-fontsize" style="width:60px">
        <button class="prop-apply" onclick="applyFontSize()">Apply</button>
      </div>
    </div>
    <div class="prop-row" id="prop-pos-row">
      <label>Position (x, y)</label>
      <div class="inline">
        <input type="text" id="prop-x" placeholder="x" style="width:60px">
        <input type="text" id="prop-y" placeholder="y" style="width:60px">
        <button class="prop-apply" onclick="applyPos()">Apply</button>
      </div>
    </div>
  </div>
</div>
</div>

<!-- Inline text editor -->
<div id="text-editor"><input id="text-editor-input"></div>

<!-- Toast -->
<div id="toast"></div>

<script>
// ═══════════ State ═══════════
let selected = null;
const svg = document.getElementById('diagram');
const origSVG = svg.outerHTML; // for reset

// ═══════════ Helpers ═══════════
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function colorToHex(c) {
  if (!c) return '#000000';
  if (c.startsWith('#')) {
    if (c.length === 4) return '#' + c[1]+c[1] + c[2]+c[2] + c[3]+c[3];
    return c;
  }
  if (c.startsWith('rgb')) {
    const m = c.match(/\d+/g);
    if (m) return '#' + m.slice(0,3).map(n => (+n).toString(16).padStart(2,'0')).join('');
  }
  if (c === 'white') return '#ffffff';
  if (c === 'none') return '#000000';
  return c;
}

// ═══════════ Selection ═══════════
function deselect() {
  if (selected) { selected.classList.remove('el-selected'); selected = null; }
  document.getElementById('panel-empty').style.display = '';
  document.getElementById('panel-props').style.display = 'none';
}

function select(el) {
  deselect();
  selected = el;
  el.classList.add('el-selected');
  showProps(el);
}

function showProps(el) {
  document.getElementById('panel-empty').style.display = 'none';
  document.getElementById('panel-props').style.display = '';

  const tag = el.tagName.toLowerCase();
  document.getElementById('prop-type').value = tag;

  // Text
  const textRow = document.getElementById('prop-text-row');
  if (tag === 'text') {
    textRow.style.display = '';
    document.getElementById('prop-text').value = el.textContent.trim();
  } else { textRow.style.display = 'none'; }

  // Fill
  const fillRow = document.getElementById('prop-fill-row');
  const fill = el.getAttribute('fill');
  if (fill && fill !== 'none' && !fill.startsWith('url')) {
    fillRow.style.display = '';
    const hex = colorToHex(fill);
    document.getElementById('prop-fill').value = hex;
    document.getElementById('prop-fill-hex').textContent = hex;
  } else { fillRow.style.display = 'none'; }

  // Stroke
  const strokeRow = document.getElementById('prop-stroke-row');
  const stroke = el.getAttribute('stroke');
  if (stroke && stroke !== 'none') {
    strokeRow.style.display = '';
    const hex = colorToHex(stroke);
    document.getElementById('prop-stroke').value = hex;
    document.getElementById('prop-stroke-hex').textContent = hex;
  } else { strokeRow.style.display = 'none'; }

  // Font size
  const fsRow = document.getElementById('prop-fontsize-row');
  if (tag === 'text') {
    fsRow.style.display = '';
    document.getElementById('prop-fontsize').value = el.getAttribute('font-size') || '';
  } else { fsRow.style.display = 'none'; }

  // Position
  const posRow = document.getElementById('prop-pos-row');
  if (el.hasAttribute('x') && el.hasAttribute('y')) {
    posRow.style.display = '';
    document.getElementById('prop-x').value = el.getAttribute('x');
    document.getElementById('prop-y').value = el.getAttribute('y');
  } else if (el.hasAttribute('cx') && el.hasAttribute('cy')) {
    posRow.style.display = '';
    document.getElementById('prop-x').value = el.getAttribute('cx');
    document.getElementById('prop-y').value = el.getAttribute('cy');
  } else { posRow.style.display = 'none'; }
}

// ═══════════ Apply changes ═══════════
function applyText() {
  if (!selected || selected.tagName !== 'text') return;
  selected.textContent = document.getElementById('prop-text').value;
  toast('Text updated');
}

function applyFill() {
  if (!selected) return;
  const c = document.getElementById('prop-fill').value;
  selected.setAttribute('fill', c);
  document.getElementById('prop-fill-hex').textContent = c;
  toast('Fill colour updated');
}

function applyStroke() {
  if (!selected) return;
  const c = document.getElementById('prop-stroke').value;
  selected.setAttribute('stroke', c);
  document.getElementById('prop-stroke-hex').textContent = c;
  toast('Stroke colour updated');
}

function applyFontSize() {
  if (!selected || selected.tagName !== 'text') return;
  selected.setAttribute('font-size', document.getElementById('prop-fontsize').value);
  toast('Font size updated');
}

function applyPos() {
  if (!selected) return;
  const x = document.getElementById('prop-x').value;
  const y = document.getElementById('prop-y').value;
  if (selected.hasAttribute('x')) { selected.setAttribute('x', x); selected.setAttribute('y', y); }
  else if (selected.hasAttribute('cx')) { selected.setAttribute('cx', x); selected.setAttribute('cy', y); }
  toast('Position updated');
}

// ═══════════ Click / Double-click on SVG ═══════════
svg.addEventListener('click', function(e) {
  e.stopPropagation();
  let el = e.target;
  // Skip defs, markers, symbols
  if (el.closest('defs') || el.closest('marker') || el.closest('symbol')) return;
  if (el === svg) { deselect(); return; }
  select(el);
});

// Double-click text → inline edit
svg.addEventListener('dblclick', function(e) {
  const el = e.target;
  if (el.tagName !== 'text') return;
  e.preventDefault();
  const editor = document.getElementById('text-editor');
  const input = document.getElementById('text-editor-input');
  const rect = el.getBoundingClientRect();
  editor.style.left = rect.left + 'px';
  editor.style.top = (rect.top - 4) + 'px';
  editor.style.display = 'block';
  input.value = el.textContent.trim();
  input.style.fontSize = (rect.height * 0.85) + 'px';
  input.focus();
  input.select();

  function finish() {
    el.textContent = input.value;
    editor.style.display = 'none';
    input.removeEventListener('blur', finish);
    input.removeEventListener('keydown', onKey);
    if (selected === el) showProps(el);
    toast('Text updated');
  }
  function onKey(ev) { if (ev.key === 'Enter') { ev.preventDefault(); finish(); } if (ev.key === 'Escape') { editor.style.display = 'none'; } }
  input.addEventListener('blur', finish);
  input.addEventListener('keydown', onKey);
});

// Click outside SVG → deselect
document.addEventListener('click', function(e) {
  if (!e.target.closest('#canvas') && !e.target.closest('#panel')) deselect();
});

// ═══════════ Drag to move ═══════════
let dragging = false, dragEl = null, dragStart = {x:0, y:0}, origAttrs = {};

svg.addEventListener('mousedown', function(e) {
  if (e.button !== 0) return;
  let el = e.target;
  if (el.closest('defs') || el === svg) return;
  // Only drag text & rect (not lines/tiny squares for simplicity)
  const tag = el.tagName.toLowerCase();
  if (tag !== 'text' && tag !== 'rect') return;
  if (!el.hasAttribute('x') || !el.hasAttribute('y')) return;
  // Don't drag small grid squares (width <= 14)
  if (tag === 'rect' && parseFloat(el.getAttribute('width')) <= 14) return;

  dragging = true;
  dragEl = el;
  const pt = svg.createSVGPoint();
  pt.x = e.clientX; pt.y = e.clientY;
  const svgPt = pt.matrixTransform(svg.getScreenCTM().inverse());
  dragStart = { x: svgPt.x, y: svgPt.y };
  origAttrs = { x: parseFloat(el.getAttribute('x')), y: parseFloat(el.getAttribute('y')) };
  e.preventDefault();
});

window.addEventListener('mousemove', function(e) {
  if (!dragging || !dragEl) return;
  const pt = svg.createSVGPoint();
  pt.x = e.clientX; pt.y = e.clientY;
  const svgPt = pt.matrixTransform(svg.getScreenCTM().inverse());
  dragEl.setAttribute('x', origAttrs.x + (svgPt.x - dragStart.x));
  dragEl.setAttribute('y', origAttrs.y + (svgPt.y - dragStart.y));
  if (selected === dragEl) showProps(dragEl);
});

window.addEventListener('mouseup', function() {
  if (dragging) { dragging = false; dragEl = null; }
});

// ═══════════ Download ═══════════
function getCleanSVG() {
  // Clone SVG, remove editor classes
  const clone = svg.cloneNode(true);
  clone.querySelectorAll('.el-selected').forEach(e => e.classList.remove('el-selected'));
  clone.removeAttribute('id');
  return clone;
}

function downloadHTML() {
  const clone = getCleanSVG();
  const html = `<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UpANNS Architecture Diagram</title>
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&family=Times+New+Roman&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { background: #fff; display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 10px; font-family: 'Source Sans Pro', serif; }
.container { width: 100%; max-width: 1300px; }
svg text { font-family: 'Source Sans Pro', 'Times New Roman', serif; }
</style>
</head>
<body>
<div class="container">
${clone.outerHTML}
</div>
</body>
</html>`;
  const blob = new Blob([html], { type: 'text/html' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'diagram.html'; a.click();
  URL.revokeObjectURL(url);
  toast('HTML downloaded');
}

function downloadSVG() {
  const clone = getCleanSVG();
  const blob = new Blob([clone.outerHTML], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'diagram.svg'; a.click();
  URL.revokeObjectURL(url);
  toast('SVG downloaded');
}

// ═══════════ Reset ═══════════
function resetAll() {
  if (!confirm('Reset all changes? This cannot be undone.')) return;
  document.getElementById('canvas').innerHTML = origSVG;
  // Re-bind svg reference (it was replaced)
  location.reload();
}
</script>
</body>
</html>
